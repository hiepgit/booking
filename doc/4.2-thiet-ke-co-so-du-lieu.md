### 4.2. Thiết kế cơ sở dữ liệu

#### ERD tổng quan

```mermaid
erDiagram
    USER {
      string id PK
      string email
      string phone
      string password
      string role
      boolean isActive
      boolean isVerified
      datetime createdAt
      datetime updatedAt
    }

    PATIENT {
      string id PK
      string userId FK
      string bloodType
      string allergies
      string emergencyContact
      string insuranceNumber
    }

    DOCTOR {
      string id PK
      string userId FK
      string licenseNumber
      string specialtyId FK
      int    experience
      float  consultationFee
      float  averageRating
      int    totalReviews
      boolean isAvailable
    }

    SPECIALTY {
      string id PK
      string name
      string description
      string icon
    }

    CLINIC {
      string id PK
      string name
      string address
      string phone
      string email
      float  latitude
      float  longitude
      string openTime
      string closeTime
    }

    CLINIC_DOCTOR {
      string id PK
      string clinicId FK
      string doctorId FK
      string workingDays
      string startTime
      string endTime
    }

    SCHEDULE {
      string id PK
      string doctorId FK
      date   date
      string startTime
      string endTime
      string status
      string note
    }

    APPOINTMENT {
      string id PK
      string patientId FK
      string doctorId FK
      string clinicId FK
      string scheduleId FK
      datetime appointmentDate
      string startTime
      string endTime
      string type
      string status
      string symptoms
      string notes
      string meetingUrl
      string meetingId
      datetime createdAt
      datetime updatedAt
    }

    PAYMENT {
      string id PK
      string appointmentId FK
      string patientId FK
      float  amount
      string method
      string status
      string transactionId
      string gatewayResponse
      datetime paidAt
      datetime createdAt
      datetime updatedAt
    }

    MEDICAL_RECORD {
      string id PK
      string appointmentId FK
      string patientId FK
      string doctorId FK
      string type
      string diagnosis
      string prescription
      string labResults
      string treatmentPlan
      string notes
      string attachments
      datetime createdAt
      datetime updatedAt
    }

    REVIEW {
      string id PK
      string patientId FK
      string doctorId FK
      int    rating
      string comment
      datetime createdAt
      datetime updatedAt
    }

    NOTIFICATION {
      string id PK
      string userId FK
      string type
      string title
      string message
      string data
      boolean isRead
      datetime createdAt
    }

    MESSAGE {
      string id PK
      string senderId FK
      string receiverId FK
      string content
      string messageType
      string fileUrl
      boolean isRead
      datetime createdAt
    }

    APPCONFIG {
      string id PK
      string key
      string value
      string description
      datetime createdAt
      datetime updatedAt
    }

    AUDIT_LOG {
      string id PK
      string userId FK
      string action
      string tableName
      string recordId
      string oldValues
      string newValues
      string ipAddress
      string userAgent
      datetime createdAt
    }

    USER ||--o| PATIENT : has_profile
    USER ||--o| DOCTOR : has_profile
    USER ||--o{ NOTIFICATION : receives
    USER ||--o{ MESSAGE : sends
    USER ||--o{ MESSAGE : receives

    SPECIALTY ||--o{ DOCTOR : includes
    DOCTOR ||--o{ SCHEDULE : defines
    DOCTOR ||--o{ APPOINTMENT : attends
    PATIENT ||--o{ APPOINTMENT : books
    CLINIC ||--o{ APPOINTMENT : hosts
    SCHEDULE ||--o{ APPOINTMENT : slots

    APPOINTMENT ||--o| PAYMENT : has
    APPOINTMENT ||--o| MEDICAL_RECORD : generates
    PATIENT ||--o{ PAYMENT : pays
    PATIENT ||--o{ MEDICAL_RECORD : owns
    DOCTOR ||--o{ MEDICAL_RECORD : writes

    PATIENT ||--o{ REVIEW : creates
    DOCTOR ||--o{ REVIEW : receives

    CLINIC ||--o{ CLINIC_DOCTOR : maps
    DOCTOR ||--o{ CLINIC_DOCTOR : maps

    USER ||--o{ AUDIT_LOG : actions
```

#### Ghi chú quan hệ và ràng buộc
- Mỗi `User` có tối đa một `Patient` hoặc một `Doctor` (1-0..1). Hai hồ sơ này loại trừ lẫn nhau theo vai trò.
- `User.email`, `User.phone`, `Doctor.licenseNumber`, `Specialty.name`, `Payment.transactionId` là duy nhất (unique).
- `Doctor` thuộc một `Specialty` (n-1). `Specialty` có nhiều `Doctor`.
- `Doctor` có nhiều `Schedule` (1-n). Mỗi `Schedule` xác định ngày + khung giờ duy nhất cho bác sĩ.
- `Appointment` liên kết `Patient` — `Doctor` — (tùy chọn) `Clinic` — (tùy chọn) `Schedule`.
- `Payment` và `MedicalRecord` là 1-1 với `Appointment` (tối đa một bản ghi cho mỗi cuộc hẹn).
- `Review` là quan hệ n-n giữa `Patient` và `Doctor` với ràng buộc duy nhất 1 đánh giá cho mỗi cặp.
- `ClinicDoctor` là bảng mapping n-n giữa `Clinic` và `Doctor` với ràng buộc duy nhất theo cặp (clinicId, doctorId).
- `Notification`, `Message`, `AuditLog` gắn với `User`; `Message` có quan hệ người gửi/người nhận.


